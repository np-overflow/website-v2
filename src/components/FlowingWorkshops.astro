---
import { getImage } from 'astro:assets'
import { getEvents } from '../lib/api'
import * as workshopImages from '../images/workshops'

const events = getEvents()
const workshops = events.type.find(type => type.title === "Workshops")?.events || []

const workshopData = (await Promise.all(
  workshops.map(async (workshop) => {
    if (!workshop.workshop_folder) return null
    const folderImageModules = Object.entries(workshopImages)
      .filter(([key]) => key.startsWith(workshop.workshop_folder!.replace(' ', '')))
      .map(([, imageModule]) => imageModule)
    if (folderImageModules.length === 0) return null
    const optimizedImages = await Promise.all(
      folderImageModules.map((mod) =>
        getImage({ src: mod as any, width: 480, format: 'webp' })
      )
    )
    return {
      title: workshop.title,
      images: optimizedImages.map((img) => img.src),
    }
  })
)).filter((item): item is NonNullable<typeof item> => item !== null)

const MAX_WORKSHOPS = 8
for (let i = workshopData.length - 1; i > 0; i--) {
  const j = Math.floor(Math.random() * (i + 1));
  [workshopData[i], workshopData[j]] = [workshopData[j], workshopData[i]]
}
workshopData.length = Math.min(workshopData.length, MAX_WORKSHOPS)

const mobileItemCount = Math.min(workshopData.length, Math.floor(workshopData.length * 0.6))
---

<div class="relative overflow-hidden h-[50vh] flowing-workshop-container">
  <!-- Mobile workshops - Portrait -->
  {workshopData.slice(0, mobileItemCount).map((workshop) => (
    <div
      class="absolute w-48 h-36 border-2 border-white rounded-lg bg-white p-2 flowing-workshop-mobile xl:hidden mobile-portrait-only"
      data-images={JSON.stringify(workshop.images)}
      data-mode="mobile-portrait"
      style="opacity: 0;"
    >
      <img src={workshop.images[0]} alt={workshop.title} class="w-full h-24 object-cover rounded" />
      <p class="text-xs font-medium text-center text-gray-800 mt-1 px-1">{workshop.title}</p>
    </div>
  ))}

  <!-- Mobile workshops - Landscape -->
  {workshopData.slice(0, mobileItemCount).map((workshop) => (
    <div
      class="absolute w-48 h-36 border-2 border-white rounded-lg bg-white p-2 flowing-workshop-mobile xl:hidden mobile-landscape-only"
      data-images={JSON.stringify(workshop.images)}
      data-mode="mobile-landscape"
      style="opacity: 0;"
    >
      <img src={workshop.images[0]} alt={workshop.title} class="w-full h-24 object-cover rounded" />
      <p class="text-xs font-medium text-center text-gray-800 mt-1 px-1">{workshop.title}</p>
    </div>
  ))}

  <!-- Desktop workshops -->
  {workshopData.map((workshop) => (
    <div
      class="absolute w-60 h-45 border-2 border-white rounded-lg bg-white p-2 flowing-workshop hidden xl:block"
      data-images={JSON.stringify(workshop.images)}
      data-mode="desktop"
      style="opacity: 0;"
    >
      <img src={workshop.images[0]} alt={workshop.title} class="w-full h-32 object-cover rounded" />
      <p class="text-sm font-medium text-center text-gray-800 mt-2 px-1">{workshop.title}</p>
    </div>
  ))}

  <div class="absolute inset-y-0 left-0 w-32 bg-gradient-to-r from-[#f6f7fc] dark:from-[#000212] to-transparent pointer-events-none z-0"></div>
  <div class="absolute inset-y-0 right-0 w-32 bg-gradient-to-l from-[#f6f7fc] dark:from-[#000212] to-transparent pointer-events-none z-0"></div>
</div>

<script is:inline>
  (function() {
    function shuffle(arr) {
      for (var i = arr.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = arr[i];
        arr[i] = arr[j];
        arr[j] = tmp;
      }
      return arr;
    }

    var duration = 25;
    var topBound = 15;
    var modes = {
      'mobile-portrait': 40,
      'mobile-landscape': 30,
      'desktop': 45
    };
    var borderColors = ['border-white', 'border-gray-300', 'border-orange-400'];

    for (var mode in modes) {
      var bottomBound = modes[mode];
      var elements = document.querySelectorAll('[data-mode="' + mode + '"]');
      var count = elements.length;
      if (count === 0) continue;

      var usableRange = bottomBound - topBound;

      var yPositions = [];
      var phases = [];
      for (var k = 0; k < count; k++) {
        var segment = usableRange / Math.max(1, count);
        yPositions.push(topBound + (k + 0.5) * segment);
        phases.push((k + 0.5) / Math.max(1, count));
      }
      shuffle(yPositions);
      shuffle(phases);

      for (var i = 0; i < count; i++) {
        var el = elements[i];

        // Random image
        var images = JSON.parse(el.getAttribute('data-images'));
        var img = el.querySelector('img');
        if (img && images.length > 0) {
          img.src = images[Math.floor(Math.random() * images.length)];
        }

        // Random y position with jitter
        var yJitter = (Math.random() * 0.6) - 0.3;
        var yRaw = yPositions[i] + yJitter;
        var y = Math.max(topBound + 1, Math.min(bottomBound - 1, yRaw));

        // Random animation delay (negative means pre-positioned in cycle)
        var delayJitter = (Math.random() * 1.5) - 0.75;
        var delay = -(phases[i] * duration) + delayJitter;

        // Random tilt
        var tilt = (Math.random() - 0.5) * 30;

        // Random border
        var borderColor = borderColors[i % 3];
        var isDotted = Math.random() > 0.5;

        // Apply styles
        el.style.top = y + '%';
        el.style.setProperty('--tilt', tilt + 'deg');
        el.style.animationDelay = delay + 's';
        el.style.opacity = '1';

        // Update border classes
        el.classList.remove('border-white', 'border-gray-300', 'border-orange-400', 'border-dotted');
        el.classList.add(borderColor);
        if (isDotted) el.classList.add('border-dotted');
      }
    }
  })();
</script>

<style>
  @keyframes flow {
    from { transform: translateX(calc(100vw + 250px)) rotate(var(--tilt)); }
    to { transform: translateX(-300px) rotate(var(--tilt)); }
  }

  @keyframes flow-mobile {
    from { transform: translateX(calc(100vw + 200px)) rotate(var(--tilt)); }
    to { transform: translateX(-250px) rotate(var(--tilt)); }
  }

  .flowing-workshop {
    --tilt: 0deg;
    animation: flow 25s linear infinite;
  }

  .flowing-workshop-mobile {
    --tilt: 0deg;
    animation: flow-mobile 25s linear infinite;
  }

  @media (max-width: 1279px) {
    .flowing-workshop-container {
      height: 48vh;
    }

    @media (min-aspect-ratio: 4/3) {
      .flowing-workshop-container {
        height: 56vh;
      }
    }

    @media (min-aspect-ratio: 3/2) {
      .flowing-workshop-container {
        height: 64vh;
      }
    }

    @media (min-aspect-ratio: 16/9) {
      .flowing-workshop-container {
        height: 72vh;
      }
    }

    .mobile-portrait-only {
      display: block;
    }

    .mobile-landscape-only {
      display: none;
    }

    @media (min-aspect-ratio: 4/3) {
      .mobile-portrait-only {
        display: none;
      }

      .mobile-landscape-only {
        display: block;
      }
    }
  }
</style>
